# 需求分析

## 输入
1.  **多组 CSV 文件**（服务器数据）：
    *   包含字段：区服ID, 前2名战力之和, 最高玩家累充金额, DAU, 以及其他详情。
    *   格式细节：
        *   第一行可能是索引（0,1,2...），第二行才是实际表头。
        *   同一个区服ID可能在不同日期出现多次，需要找到其中“前2名战力之和”最大的那一行（通过预先排序实现）。
2.  **一个 XLSX 文件**（合服计划）：
    *   包含字段：目标服, 参与服, 合服时间等。
    *   描述了区服之间的配对关系。
3.  **多组区服ID对**（文本输入）：
    *   格式：每行一对，逗号分隔（例如 `409474,409370`）。
    *   代表需要检查的拟定合服对。

## 处理流程

### 1. 数据预处理
*   将上传的多个 CSV 文件合并为一个总表。
*   转换关键列（区服ID, 战力, 累充, DAU）为数值类型。
*   **排序**：对总表按【前2名战力之和】降序排序。
*   **排名**：基于排序结果，计算每个服的【真实排名】（从1开始）。

### 2. 查询警报 (Primary Alert)
*   遍历输入的每一对区服 ID (`S1`, `S2`)。
*   在 CSV 数据中查找这两个服的详情（取排序后的第一条匹配数据）。
*   **警报条件**（满足任意其一即触发）：
    1.  **排名接近**：`abs(Rank1 - Rank2) <= 5`。
    2.  **高战高充**：两者排名都在前 25% **且** 两者【最高玩家累充金额】都在 5000 以上。
    3.  **战力差距小**：`abs(Power1 - Power2) <= 10亿`。
*   **结果分类**：
    *   触发警报 -> 进入「警报组」逻辑。
    *   未触发 -> 进入「正常组」逻辑。

### 3. 二次查询警报 (Secondary Alert)
*   仅针对「警报组」。
*   对于组内的 ID (`S1`, `S2`)，分别在 XLSX 文件中查询它们的**配对服**（Target/Partner）。
    *   例如：`S1` 在 XLSX 中可能和 `P1` 配对，`S2` 可能和 `P2` 配对。
*   **二次警报条件**：
    *   检查 `S1`, `S2`, `P1`, `P2` 这四个（或更少）相关服的 **DAU**。
    *   如果有**任意一个**服的 DAU <= 5，则触发二次警报。
*   **输出**：
    *   将原始警报组的信息，以及触发二次警报的相关服信息，累积到警报结果中。

### 4. 合并申请处理 (Merge Requests)
*   仅针对「正常组」。
*   输入对 `(S1, S2)` 被视为一个**合并申请**，即希望 `S1` 和 `S2` 在同一行（成为合服对）。
*   在 XLSX 文件中定位 `S1` 所在的行（`R1`）和 `S2` 所在的行（`R2`）。
*   **合并逻辑 (Merge Logic)**：
    *   **目标行 (`R1`)**：将 `S1` 和 `S2` 放入该行。这意味着 `S1` 和 `S2` 将成为一对。
    *   **剩余行 (`R2`)**：将原本与 `S1` 配对的服（`P1`）和原本与 `S2` 配对的服（`P2`）提取出来，组成一对放入该行。这被称为“剩余自动组队”。
    *   **排序修正**：对这两行的新配对分别进行排序，确保每行中数值较小的 ID 作为【目标服】（在前），数值较大的作为【参与服】（在后）。
*   **样式标记**：将发生变更的行（`R1`, `R2`）背景标记为黄色。
*   **更新索引**：更新内存映射，`S1, S2` 指向 `R1`，`P1, P2` 指向 `R2`。
*   **限制**：如果 `S1` 或 `S2` 在 XLSX 中找不到，或者它们已经在同一行，则跳过并记录日志。

## 输出
1.  **警报 CSV (`alert_result.csv`)**：包含所有触发警报的区服详情及警报原因。
2.  **交换日志 CSV (`swapped_log.csv`)**：记录所有成功执行交换操作的区服对及对应的 Excel 行号。
3.  **结果 XLSX (`result_plan.xlsx`)**：修改后的合服计划表（包含交换和标色）。
4.  **网页统计**：显示警报组数量和成功交换组数量。
